<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 TRANSITIONAL//EN">
<html>
	<head>
		<title>HMTF TBragg</title>
		<!-- include the mhttpd JS library -->
		<script src="/js/mhttpd.js" type="text/javascript"></script>
		<script src="tbraggJS!" type="text/javascript"></script>
		<script src='spectrumViewerJS!' type='text/javascript'></script>

		<script type="text/javascript">
			var my_action = '"/CS/try&"'
			var ival;
			var my_expt="midas";
		</script>

		<style type="text/css">
			.t1{clear:both; width:25%; float:left; text-align:right; margin:0px 0px 0px 0px;}
			.t2{width:70%; float:left; text-align:left; margin:0px 0px 0px 0px;}
			.c1{height:30px;  margin:0px 53px 0px 0px;}
			.c1t{height:30px; margin:3px 5px 0px 0px;}
			.c2{height:30px; margin:0px 0px 0px 0px;}
			.buff{clear:both; width:100%; height:15px;}
			.limitBox{width:130px}
			td{padding:0px;}
			button.navLink{
				background: #4C4C4C; 
				color: #999999;
				border-color: #333333; 
				border-radius: 5px;
			    display: inline;
			    font-family: 'Raleway', sans-serif;
			    font-size:14px;
			}

			table.mainElement{
				border:5px solid; 
				border-radius:25px; 
				padding:10px;
			}

			body.standard{
				background:#333333; 
				color:#999999; 
				font-family: "Raleway", sans-serif;				
			}

			:invalid{
				color: #FF0000;
			}
		</style>
	</head>

	<body id='body' class='standard'>

		<div id='loading' style='width:100px; height:100px; border:5px solid; border-color:#FFFFFF; border-radius:25px; background:#000000; text-align:center; margin-left:auto; margin-right:auto; position:relative; top:300px'><p style='position:relative; top:50px; font:16px Arial'>Loading<p></div>

	    <script type="text/javascript">
	      //load the webfonts, and block the page until they're ready or failed - otherwise lots of rendering bugs happen!
	      WebFontConfig = { google: { families: [ 'Orbitron', 'Raleway' ] },
	        loading: function(){

	        },
	        active: function() {
	          main();
	        },
	        inactive: function() {
	          main();
	        }
	      };
	      //thx paul:
	      (function() {
	        var wf = document.createElement('script');
	        wf.src = ('https:' == document.location.protocol ? 'https' : 'http') +
	            '://ajax.googleapis.com/ajax/libs/webfont/1/webfont.js';
	        wf.type = 'text/javascript';
	        wf.async = 'true';
	        var s = document.getElementsByTagName('script')[0];
	        s.parentNode.insertBefore(wf, s);
	      })();
	    </script>

	    <div id='mainBody' style='opacity:0'>

			<div id='branding' style='width:100%; height:100; border-color:#999999; border-left-style:solid; border-bottom-style:solid; border-left-width:5px; border-bottom-width:5px; border-bottom-left-radius:25px; background-color:#333333; margin-bottom:5px;'>
				<img id='logo' height='80px' width='80px' src='triumf.gif' style='opacity:0.5625; padding-left:10px;'></img>
				<h1 id='title' style='position:relative; display:inline; font: 80px Raleway; top:-10px'>TRIUMF</h1>
			</div>

			<div id='navbar' style='width: 100%; height: 30px; margin-bottom:10px;'>
				<button id='startB' class='navLink' name="cmd" value="Start" type="submit" onclick="setResetTime()">Start</button>
				<button id='statusB' class='navLink' name="cmd" value="Status" type="submit">MIDAS Status</button>
				<button id='historyB' class='navLink' name="cmd" value="History" type="submit">History</button>
				<input type=hidden name="redir" value="/CS/Monitor">
				<button id='run5B' class='navLink' type=submit name=customscript value="Start 5 Min Run" onclick="setResetTime()">Start 5 Min Run</button>
				<h2 id='youAreHere' style='position:absolute; display:inline; margin:0px; right:20px;'>TBRAGG Monitor</h2>
			</div>

			<table class='mainElement' width='100%' style='text-align:center'>
				<caption>Run Status</caption>
				<tr>
					<td id="run_status" align='center' width='33%' style='color:#000000'></td>
					<td id="run_num" width='34%'></td>
					<td id='dateLine' width='33%'></td>				
				</tr>
			</table>

			<table class='mainElement' width='100%' style='margin-top:10px;'>
				<caption>Gate Parameters</caption>
				<tr style='text-align:center; margin-bottom:10px;'>
					<td align='center' width='100%'>
						Number of Gates: 1<input type="radio" id="g0" value="0" onclick="set_radios(this)"> 
						2<input type="radio" id="g1" value="1" onclick="set_radios(this)"> 
						3<input type="radio" id="g2" value="2" onclick="set_radios(this)"> 
						4<input type="radio" id="g3" value="3" onclick="set_radios(this)"> 
					</td>
				</tr>
				<tr id='Gate_params'></tr>
			</table>

			<form name="mainform" style='text-align:center; margin-top:30px;'>
				<table id='masterTable' style='margin-top:10px; position:relative; margin-left:auto; margin-right:auto;'>
					<tr>
						<td id='el1'>

							<table id='spectrumBlock2D' class='mainElement' style='height:100%'>
								<caption style='font: 20px Raleway'>Spectrum Control</caption>

								<tr>
									<td colspan='3' width='auto'>
										<canvas id='canvas2D' style='margin-right:10px'></canvas>
									</td>
								</tr>

								<tr>
									<td align='left' colspan='2' style='padding:none;'>
										x axis limits: 
										<input type="number" id="LowerXLimit2D" style="width:60px;" onchange="setAxisLimit(parseInt(this.value), this.id, 'XaxisLimitMin2D', 'XaxisLimitAbsMax2D');plot_data2D(0); document.getElementById('UpperXLimit2D').setAttribute('min', this.value);" min='0' max='500'></button>
										<input type="number" id="UpperXLimit2D" style="width:60px;" onchange="setAxisLimit(parseInt(this.value), this.id, 'XaxisLimitMax2D', 'XaxisLimitAbsMax2D');plot_data2D(0); document.getElementById('LowerXLimit2D').setAttribute('max', this.value);" min='0' max='500'></button>
										<button id='bigLeft2D' class='navLink' type="button" value="<<" onclick="scrollSpectra(SVparam.XaxisLimitMin2D - SVparam.XaxisLimitMax2D, 'XaxisLimitMin2D', 'XaxisLimitMax2D', 'XaxisLimitAbsMax2D', 'LowerXLimit2D', 'UpperXLimit2D'); plot_data2D(0)"><<</button>
										<button id='smallLeft2D' class='navLink' type="button" value="<" onclick="scrollSpectra(-1, 'XaxisLimitMin2D', 'XaxisLimitMax2D', 'XaxisLimitAbsMax2D', 'LowerXLimit2D', 'UpperXLimit2D'); plot_data2D(0)"><</button>
										<button id='smallRight2D' class='navLink' type="button" value=">" onclick="scrollSpectra(1, 'XaxisLimitMin2D', 'XaxisLimitMax2D', 'XaxisLimitAbsMax2D', 'LowerXLimit2D', 'UpperXLimit2D'); plot_data2D(0)">></button>
										<button id='bigRight2D' class='navLink' type="button" value=">>" onclick="scrollSpectra(SVparam.XaxisLimitMax2D - SVparam.XaxisLimitMin2D, 'XaxisLimitMin2D', 'XaxisLimitMax2D', 'XaxisLimitAbsMax2D', 'LowerXLimit2D', 'UpperXLimit2D'); plot_data2D(0)">>></button>
										<div id="limitMistake2D" style="color:'#00FFFF'"></div>
									</td>

									<td colspan='1'>
										<p id="2Dcoords"></p>
									</td>
								</tr>

								<tr>
									<td align='left' colspan='3' style='padding:none;'>
										y axis limits: 
										<input type="number" id="LowerYLimit" style="width:60px;" onchange="setAxisLimit(parseInt(this.value), this.id, 'YaxisLimitMin2D', 'YaxisLimitAbsMax2D');plot_data2D(0); document.getElementById('UpperYLimit').setAttribute('min', this.value);" min='0' max='500'></button>
										<input type="number" id="UpperYLimit" style="width:60px;" onchange="setAxisLimit(parseInt(this.value), this.id, 'YaxisLimitMax2D', 'YaxisLimitAbsMax2D');plot_data2D(0); document.getElementById('LowerYLimit').setAttribute('max', this.value);" min='0' max='500'></button>
										<button id='bigDown' class='navLink' type="button" value="<<" onclick="scrollSpectra(SVparam.YaxisLimitMin2D - SVparam.YaxisLimitMax2D, 'YaxisLimitMin2D', 'YaxisLimitMax2D', 'YaxisLimitAbsMax2D', 'LowerYLimit', 'UpperYLimit'); plot_data2D(0)">D</button>
										<button id='smallDown' class='navLink' type="button" value="<" onclick="scrollSpectra(-1, 'YaxisLimitMin2D', 'YaxisLimitMax2D', 'YaxisLimitAbsMax2D', 'LowerYLimit', 'UpperYLimit'); plot_data2D(0)">d</button>
										<button id='smallUp' class='navLink' type="button" value=">" onclick="scrollSpectra(1, 'YaxisLimitMin2D', 'YaxisLimitMax2D', 'YaxisLimitAbsMax2D', 'LowerYLimit', 'UpperYLimit'); plot_data2D(0)">u</button>
										<button id='bigUp' class='navLink' type="button" value=">>" onclick="scrollSpectra(SVparam.YaxisLimitMax2D - SVparam.YaxisLimitMin2D, 'YaxisLimitMin2D', 'YaxisLimitMax2D', 'YaxisLimitAbsMax2D', 'LowerYLimit', 'UpperYLimit'); plot_data2D(0)">U</button>
										<div id="limitMistake" style="color:'#00FFFF'"></div>
									</td>
								</tr>

								<!--tr>
									<td>
										z axis: Lin<input type="radio" id="a0" value="0" onclick="set_AxisType(this)" checked="true">|<input type="radio" id="a1" value="1" onclick="set_AxisType(this)">Log
									</td>							
								</tr-->

								<tr>
									<td width="400px" colspan='3' align='left' vertical-align='bottom'>
										Refresh Rate: 
										<select id="refreshRate2D" onchange="SVparam.RefreshTime=this.value; plot_data2D(0, 'true')">
											<option id="r0" value="0">Off</option>
											<option id="r1" value="1">1s</option>
											<option id="r2" value="3">3s</option>
											<option id="r3" value="5">5s</option>
											<option id="r4" value="10">10s</option>
										</select>
										<button id='refresh2D' class='navLink' type="button" value="Refresh Now" onclick="plot_data2D(0, 'true')">Refresh Now</button>
									</td>							
								</tr>

								<tr>
									<td colspan='3' align='left' style='padding:none;'>
										<button id='clearSpec2D' class='navLink' type="button" value="Clear Spectra" onclick="clearSpecs()">Clear Plot</button>
										<button id='unzoom2D' class='navLink' type="button" value="Unzoom" onclick="Unzoom();">Unzoom</button>
									</td>
								</tr>

								<tr>
									<td>
										<b>Zoom</b> 
										<select id="zoom_drop" onchange="setZoom(this.value);">
											<option id="v1" value="1">x1</option>
											<option id="v2" value="2">x2</option>
											<option id="v3" value="3">x3</option>
											<option id="v4" value="4">x4</option>
										</select>						
									</td>

									<td>
										<form method="GET" action="http://midtig04.triumf.ca:8081/CS/Monitor&">
											<button id='resetCountsB' class='navLink' type=submit name=customscript value="Reset Counts" onclick="setResetTime()">Reset Counts</button>
											<input type=hidden name="redir" value="/CS/Monitor">
										</form>
									</td>

									<td align=left style="width:100px;">
										<button id='saveASCIIB' class='navLink' type="button" value="Save ASCII" onclick="dump2D()">Save ASCII</button>
									</td>
								</tr>
							</table>





							<!--table class='mainElement' style='position:relative; top:-227px;'>
								<caption>E vs. dE</caption>
								<tr>
									<td colspan="3">
										<img id="2Dplot" src="IDPlot.gif" width=380, height=380>
									</td>					
								</tr>


								<tr>
									<td>
										<b>Zoom</b> 
										<select id="zoom_drop" onchange="setZoom(this.value);">
											<option id="v1" value="1">x1</option>
											<option id="v2" value="2">x2</option>
											<option id="v3" value="3">x3</option>
											<option id="v4" value="4">x4</option>
										</select>						
									</td>

									<td>
										<form method="GET" action="http://midtig04.triumf.ca:8081/CS/Monitor&">
											<button id='resetCountsB' class='navLink' type=submit name=customscript value="Reset Counts" onclick="setResetTime()"></button>
											<input type=hidden name="redir" value="/CS/Monitor">
										</form>
									</td>

									<td align=left style="width:100px;">
										<button id='saveASCIIB' class='navLink' type="button" value="Save ASCII" onclick="dump2D()"></button>
									</td>
								</tr>

							</table-->
						</td>

						<td id='el2'>
							<table class='mainElement' style='height:100%'>
								<caption style='font: 20px Raleway'>Gate Rates</caption>
								<tr>
									<td stlye='width:100px !important;'></td>
									<td class='limitBox'>Upper limit<br><input type="text" id="MaxT" style="width:70px" onchange="TBparam.GateMax[0]=this.value;"></td>
									<td class='limitBox'>Upper limit<br><input type="text" id="MaxG" style="width:70px" onchange="TBparam.GateMax[1]=this.value;"></td>
									<td class='limitBox' id="l1" style='opacity:0;'>Upper limit<br><input type="text" id="MaxG1" style="width:70px" onchange="TBparam.GateMax[2]=parseInt(this.value);"></td>
									<td class='limitBox' id="l2" style='opacity:0;'>Upper limit<br><input type="text" id="MaxG2" style="width:70px" onchange="TBparam.GateMax[3]=parseInt(this.value);"></td>
									<td class='limitBox' id="l3" style='opacity:0;'>Upper limit<br><input type="text" id="MaxG3" style="width:70px" onchange="TBparam.GateMax[4]=parseInt(this.value);"></td>
								</tr>

								<tr>
									<td id='rateBarCell' colspan="6">
										<canvas id='rateBars'> </canvas>
									</td>
								</tr>

								<tr style='text-align:center;'>
									<td colspan='6'>
										<span id="Time_display"></span> seconds since last reset
									</td>
								</tr>
							</table>
						</td>
					</tr>
				</table>
			</form>
		</div>

		<script type="text/javascript">
			function main(){

				//scale subtables to match
				document.getElementById('el1').setAttribute('style', 'width:auto; height:'+document.getElementById('masterTable').offsetHeight)				
				document.getElementById('el2').setAttribute('style', 'width:auto; height:'+document.getElementById('masterTable').offsetHeight)

				//TBRAGG namespace
				TBparam = {
					'svgns' : 'http://www.w3.org/2000/svg',
					'num_gates' : 0,
					'old_num_gates' : 0,
					'GateMax' : [1000,1000,1000,1000,1000],
					'ResetTime' : 0,
					'x' : 0,
					'obj' : 0,
					'i' : 0,
					'img' : 0,
					'name' : 0,
					'cmd' : 0,
					'oldLevels' : [0,0,0,0,0],
					'levels' : [0,0,0,0,0],
					'rate' : [0,0,0,0,0],
					'int' : [0,0,0,0,0],
					'barChartColors' : ['#0000FF', '#FF0000', '#00FF00', '#FFFF00', '#FF00FF']  //660099
				};
				TBparam.num_gates = parseInt(ODBGet("/Analyzer/Parameters/Gate0/NGates"));
				TBparam.ResetTime = ODBGet("/Analyzer/Parameters/Gate0/ResetTime");

				//Spectrum viewer namespace (a lot of these could be dropped, don't need the 1D functionality here)
				SVparam = {
					"devMode" : 1,
					"refreshHandler" : 0,
					"statusURL" : 'http://midtig04.triumf.ca:8082',
					"hostname" : "localhost:9092",
					"RefreshTime" : 3,
					"XaxisLimitMin" : 0,
					"XaxisLimitMax" : 500,
					"XaxisLimitAbsMax" : 512,
					"XaxisLength" : 0,
					"YaxisLimitMin" : 0,
					"YaxisLimitMax" : 204,
					"YaxisLength" : 0,
					"maxYvalue" : 200,
					"dataColor" : ["#FFFFFF", "#FF0000", "#00FFFF", "#00FF00", "#FF9900", "#0000FF", "#FFFF00", "#FF00CC", "#00CC00", "#990099"],
					"XMouseLimitxMin" : 0,
					"XMouseLimitxMax" : 0,
					"DataType" : 0,
					"AxisType" : 0,
					"Specs" : [],
					"DisplayedSpecs" : [],
					"spectrum_names" : [],
					"NumSpecsDisplayed" : 0,
					"Fitted" : 0,
					"FitLimitLower" : -1,
					"FitLimitUpper" : -1,
					"word" : 'Hello there',
					"data" : [],
					"KnownHostnames" : ["midtig03:9095", "localhost:9092"],
					"refreshMap" : [0,1,2,5,10],
					"totalEntries" : 0,

					"canvasID" : 'testCanv',			//id of canvas to draw spectra in
					"canvas" : 0,
					"context" : 0,
					'canvWidth' : 960,					//spectrum canvas width
					'canvHeight' : 420,					//  "" height
					"leftMargin" : 100,					//left gutter of plot area
					"bottomMargin" : 50, 				//bottom gutter of plot area
					"rightMargin" : 100,				//right gutter of plot area
					"topMargin" : 20, 					//top gutter of plot area
					"xAxisPixLength" : 0,				//in pixels
					"yAxisPixLength" : 0,				//in pixels
					"tickLength" : 5, 					//axis tickmark length
					"nXticks" : 6,						//number of ticks on the x axis
					"nYticks" : 5,						//number of ticks on the y axis
					"xLabelOffset" : 5, 				//x axis labels sit this far below the bottom of their tick
					"yLabelOffset" : 5, 				//y axis labels sit this many pix to the left of their tick
					"binWidth" : 0, 					//width of histo bin in pixels
					"countHeight" : 0, 					//height in pix accrued by a bin for each count
					"baseFont" : '16px Arial',			//default font
					"expFont" : '12px Arial',			//exponent font
					"clickBounds" : [],					//bounds clicked by the user
					"fitModeEngage" : 0, 				//determines if the event listeners on the canvas initiate zoom (0) or fit (1) procedures
					"dataBuffer" : [],					//buffer data so we don't re-fetch it.

					'canvasID2D' : 'canvas2D',
					'canvas2D' : 0,
					'context2D' : 0,
					'canvWidth2D' : 0,
					'canvHeight2D' : 0,
					'binWidth2D' : 0,
					'binHeight2D' : 0,
					'XaxisLimitMin2D' : 0,
					'XaxisLimitMax2D' : 500,
					'XaxisLimitAbsMax2D' : 500,
					'YaxisLimitMin2D' : 0,
					'YaxisLimitMax2D' : 500,
					'YaxisLimitAbsMax2D' : 500,
					'xAxisPixLength2D' : 0,
					'yAxisPixLength2D' : 0,
					"leftMargin2D" : 100,					//left gutter of plot area
					"bottomMargin2D" : 70, 				//bottom gutter of plot area
					"rightMargin2D" : 20,				//right gutter of plot area
					"topMargin2D" : 50, 					//top gutter of plot area
					'XaxisLength2D' : 0,
					'YaxisLength2D' : 0,
					'onclickXvals' : {'min':0, 'max':0},
					'onclickYvals' : {'min':0, 'max':0},
					'clickX' : {'down':-1, 'up':-1},
					'clickY' : {'down':-1, 'up':-1}
				};

				//2D canvas:
				SVparam.canvWidth2D = window.innerWidth*0.4;
				SVparam.canvHeight2D = SVparam.canvWidth2D;
				SVparam.canvas2D = document.getElementById('canvas2D');
				SVparam.context2D = SVparam.canvas2D.getContext('2d');
				SVparam.canvas2D.setAttribute('width', SVparam.canvWidth2D);
				SVparam.canvas2D.setAttribute('height', SVparam.canvHeight2D);
				document.getElementById('spectrumBlock2D').setAttribute('width', SVparam.canvWidth2D);
				SVparam.xAxisPixLength2D = SVparam.canvas2D.width - SVparam.leftMargin2D - SVparam.rightMargin2D;
				SVparam.yAxisPixLength2D = SVparam.canvas2D.height - SVparam.topMargin2D - SVparam.bottomMargin2D;
				SVparam.XaxisLength2D = SVparam.XaxisLimitMax2D-SVparam.XaxisLimitMin2D;
				SVparam.YaxisLength2D = SVparam.YaxisLimitMax2D-SVparam.YaxisLimitMin2D;
				SVparam.context2D.font = SVparam.baseFont;
				//SVparam.context2D.shadowBlur = 1;
				//fake data for now:
				var i,j;
				window.thisData = [];
				for(i=0; i<500; i++){
					for(j=0; j<500; j++){
						window.thisData[window.thisData.length] = {'x':i, 'y':j, 'z':Math.exp(-1*((i-350)*(i-350)/2/50/50+(j-200)*(j-200)/2/150/150))}
						//window.thisData[window.thisData.length] = {'x':i, 'y':j, 'z':i-2}
					}
				}	

				//style barchart canvas:
	    		document.getElementById('rateBars').setAttribute('width', 750);
	    		document.getElementById('rateBars').setAttribute('height', 800);

				//check the appropriate gate radio:
				TBparam.x="g"+TBparam.num_gates;
				document.getElementById(TBparam.x).checked=true;

				//set the right zoom level:
				TBparam.obj=document.getElementById("zoom_drop");
				TBparam.obj.selectedIndex=ODBGet("/Analyzer/Parameters/Gate0/Zoom")-1;

				//generate the gate interface:
				document.getElementById('Gate_params').innerHTML = '';
				for(TBparam.i=0; TBparam.i<TBparam.num_gates; TBparam.i++){
					document.getElementById('Gate_params').innerHTML += "<br><b>Gate"+(TBparam.i+1)+":</b> Centre of box (x,y): ";
					document.getElementById('Gate_params').innerHTML += "<input type='text' id='Gatex"+TBparam.i+"' style='width:40px'; onchange='setGateX(this)'>,";
					document.getElementById('Gate_params').innerHTML += "<input type='text' id='Gatey"+TBparam.i+"' style='width:40px'; onchange='setGateY(this)'>";
					document.getElementById('Gate_params').innerHTML += "Size: <input type='text' id='GateSize"+TBparam.i+"' style='width:40px'; onchange='setGateSize(this)'><br>";
				}

				//refresh some things and pull some stuff out of the ODB
				mod_layout();
				refreshAll();
				for(TBparam.i=0; TBparam.i<=TBparam.num_gates; TBparam.i++){
					TBparam.name="Gatex"+TBparam.i;
					TBparam.cmd="/Analyzer/Parameters/Gate"+TBparam.i+"/x";
					document.getElementById(TBparam.name).value=ODBGet(TBparam.cmd);
					TBparam.name="Gatey"+TBparam.i;
					TBparam.cmd="/Analyzer/Parameters/Gate"+TBparam.i+"/y";
					document.getElementById(TBparam.name).value=ODBGet(TBparam.cmd);
					TBparam.name="GateSize"+TBparam.i;
					TBparam.cmd="/Analyzer/Parameters/Gate"+TBparam.i+"/size";
					document.getElementById(TBparam.name).value=ODBGet(TBparam.cmd);
				}

          		//establish event listeners on 2D spectra:
				document.getElementById(SVparam.canvasID2D).onmousedown = function(event){mDown2D(event)};
				document.getElementById(SVparam.canvasID2D).onmouseup = function(event){mUp2D(event)};
				SVparam.canvas2D.addEventListener('mousemove', function(event){mMove2D(event)}, false);
				document.getElementById(SVparam.canvasID2D).onmouseout = function(event){document.getElementById('2Dcoords').innerHTML=''};

				plot_data2D();

				//kill the spinner and let the page appear
				document.getElementById('mainBody').setAttribute('style', 'opacity:1');
				var spinElt = document.getElementById('loading');
          		spinElt.parentNode.removeChild(spinElt);

          		console.log(getData2D(0))
			}
		</script>

	</body>
</html>