<html> 
  <head>

    <link id='fontLink' href='http://fonts.googleapis.com/css?family=Orbitron|Raleway' rel='stylesheet' type='text/css'>

    <script src="zepto.min.js" type="text/javascript"></script>
    <script src="utilities.js" type="text/javascript"></script>
    <script src="masterControl.js" type="text/javascript"></script>
    <script src="viewTransitions.js" type="text/javascript"></script>
    <script src="drawing.js" type="text/javascript"></script>

    <script src="Dashboard.js" type="text/javascript"></script>
    <script src="Waffle.js" type="text/javascript"></script>
    <script src="DAQ.js" type="text/javascript"></script>
    <script src="Clock.js" type="text/javascript"></script>
    <script src="Trigger.js" type="text/javascript"></script>

    <script src="masterCodex.js" type="text/javascript"></script>
    <script src="DataStructures.js" type="text/javascript"></script>
    <script src="AlarmService.js" type="text/javascript"></script>
    <script src="tooltip.js" type="text/javascript"></script>
    <script src="formHandler.js" type="text/javascript"></script>
    <script src="slider.js" type="text/javascript"></script>
    <script src="fillMeter.js" type="text/javascript"></script>
    <script src="branding.js" type="text/javascript"></script>
    <script src="StatusBar.js" type="text/javascript"></script>

    <script src="BarGraph.js" type="text/javascript"></script>
    <script src="Subsystem.js" type="text/javascript"></script>
    <script src="SHARC.js" type="text/javascript"></script>
    <script src="DESCANT.js" type="text/javascript"></script>
    <script src="HPGE.js" type="text/javascript"></script>
    <script src="PACES.js" type="text/javascript"></script>
    <script src="DANTE.js" type="text/javascript"></script>
    <script src="BAMBINO.js" type="text/javascript"></script>
    <script src="SCEPTAR.js" type="text/javascript"></script>
    <script src="SPICE.js" type="text/javascript"></script>
    <script src="TIP.js" type="text/javascript"></script>

    <link rel="stylesheet" type="text/css" href="GRIFFINcc.css" />

  </head> 


  <body style="font-family: 'Raleway', sans-serif; font-size:14px; background-color:#333333; color:#FFFFFF; margin-left:0px"> 

    <!--Branding///////////////////////////////////////////////////////////-->
    <canvas id="banner"></canvas>

    <!--Top Level Navigation////////////////////////////////////////////////////////////-->
    <div id="navBar" style='margin:none;'>
      <div id='statusLink' style='display:inline; position:relative; left:1%;'>
        <button id='MIDASstatusLink' class='navLink' type="submit">MIDAS Status</button>
        <!--All other objects will insert their nav buttons here-->
      </div>
      <p id="youAreHere" style='display: inline; color:rgba(255,255,255,0.3); font-size:24px; margin:0; position:absolute; right:0; width:;'></p>
    </div>

    <!--Waffleplate////////////////////////////////////////////////////////-->

    <div id="waffleplate" style='margin-top:2%'>      
      <!--Left Sidebar: alarms, run control, etc-->
      <!--background layer at z=0; summary level at z=1; detail hidden at z<0, called forward to z=2 onclick-->
      <div id='leftSidebarDetail' class='leftSidebar' style='z-index:-1; opacity:0;'>
        <canvas id='LeftSidebarDetailBKG' style='position:absolute; z-index:-1; left:0%;'> </canvas>  
      </div>
      <canvas id='LeftSidebarBKG' style='position:absolute; z-index:0; left:0%;'> </canvas>
      <div id='leftSidebar' class='leftSidebar' style='z-index:1;'></div>

      <!--Right Sidebars///////////////////////////////////////////////////-->
      <canvas id='SidebarBKG' style='position:absolute; z-index:-1; right:0%'> </canvas>
    </div>

    <!--Set up JSONP services, then synchronously load parameters->data stores->main routine////////////////////////////////////////////////////-->
    <script id='parameterLoad' type="text/JavaScript">
      window.parameters = {};
      window.Gatekeeper = new gatekeeper();
      window.JSONPstatus = [];

      function loadParameters(dataWeGotViaJsonp){
        for (var key in dataWeGotViaJsonp) {
          if (dataWeGotViaJsonp.hasOwnProperty(key)) {
            window.parameters[key] = dataWeGotViaJsonp[key];
          }
        }
      }

      //define function to fetch from JSONP service
      var i,j,k;
      window.JSONPstore = {};
      function parseResponse(dataWeGotViaJsonp){
        var i;
        for (var key in dataWeGotViaJsonp) {
          if (dataWeGotViaJsonp.hasOwnProperty(key)) {
            window.JSONPstore[key] = [];
            for(i=0; i<dataWeGotViaJsonp[key].length; i++){
              window.JSONPstore[key][window.JSONPstore[key].length] = {};
              for(var subkey in dataWeGotViaJsonp[key][i]){
                if(dataWeGotViaJsonp[key][i].hasOwnProperty(subkey)){
                  window.JSONPstore[key][i][subkey] = dataWeGotViaJsonp[key][i][subkey];
                }
              }
            }
          }
        }
      } 
    </script>
    <script src='parameters.json' onload='loadJSONP(window.Gatekeeper, "main");'>//experimental parameters loaded here//</script>

    <!--Main routine/////////////////////////////////////////////////////////////////////-->
    <script id='main' type="text/JavaScript">

      function main(){

        //for(var key in window.parameters) document.write(key+'<br>')
        //plug in MIDAS status page link:
        document.getElementById('MIDASstatusLink').setAttribute('onclick', "window.location='"+window.parameters.statusURL+"';")

        //state variables for what the subdetector view is showing: 0->HV, 1->Thresholds, 2->Rate
        window.subdetectorView = 2;  //rate by default

        //autodetect what size cards are plugged into what slot:
        window.parameters.moduleSizes = detectCards();

        //columns for HV monitor:
        for(i=0; i<window.parameters.moduleSizes.length; i++){
          window.parameters.columns += window.parameters.moduleSizes[i];
          if (window.parameters.moduleSizes[i] == 0) window.parameters.columns++;
        }
        //establish module labels for HV display
        moduleLabels = [];
        for(i=0; i<window.parameters.moduleSizes.length; i++){
          moduleLabels[i] = 'Slot '+i;
        }

        //Insert branding & navigation:
        Banner('banner', 'youAreHere', 'navBar', window.parameters.ExpName+' Dashboard', 'TRIUMF');

        //plug in links:
        statusLink = document.getElementById('statusLink');
        statusLink.setAttribute('action', window.parameters.statusURL);

        //set up wrapper div dimensions; minimum rendering width = 1440px, height 900px:
        window.renderWidth = Math.max(1440, window.innerWidth);
        window.renderHeight = Math.max(900*0.85,window.innerHeight*0.85)
        $('#'+window.parameters.wrapper).width(window.renderWidth);
        $('#'+window.parameters.wrapper).height(window.renderHeight);

        //Waffle onclick event will throw x and y positions up to these globals, so that
        //updateParameter() can use them to determine which channel to update.
        window.griffinDialogX;
        window.griffinDialogY;

        //declare objects:

        //master codex for finding data:
        window.codex = new masterCodex();

        //main elements///////////////////////////////////////////////////
        //dashboard
        window.dashboard = new Dashboard();

        //status bar
        window.statusBar = new StatusBar('leftSidebar');

        //HV monitor
        if(window.parameters.topDeployment['HV'])
          window.waffle = new Waffle("InputLayer",'mainframeLinks', AlarmServices);

        //Subsystems:
        if(window.parameters.topDeployment['Subsystems']){
          //Subsystem sidebar:
          insertDOM('div', 'SubsystemSidebar', 'Sidebar', '', window.parameters.wrapper, '', '');
          //Subsystem menu; universal buttons declared outside of individual subsystems:
          //add top level nav button:
          insertDOM('button', 'SubsystemsButton', 'navLink', '', 'statusLink', '', 'Subsystem Monitors', '', '');
          //create nav panel for subsystem view:
          insertDOM('div', 'SubsystemLinks', 'navPanel', '', window.parameters.wrapper, '', '');
          //headline for nav panel
          insertDOM('h1', 'SubsystemLinksBanner', 'navPanelHeader', '', 'SubsystemLinks', '', window.parameters.ExpName+' Subsystem Monitors');
          insertDOM('br', 'break', '', '', 'SubsystemLinks', '', '');    
          //subdetectors
          window.Subdetectors = [];
          //determine number of subdetectors deployed:
          window.nDetectors = 0;
          for(var key in window.parameters.deployment){
            window.nDetectors+=window.parameters.deployment[key]
          }
          if(window.parameters.deployment["SHARC"]) window.Subdetectors[window.Subdetectors.length] = new SHARC();
          if(window.parameters.deployment["HPGe"]) window.Subdetectors[window.Subdetectors.length] = new HPGe();
          if(window.parameters.deployment["DESCANT"]) window.Subdetectors[window.Subdetectors.length] = new DESCANT();
          if(window.parameters.deployment["PACES"]) window.Subdetectors[window.Subdetectors.length] = new PACES();
          if(window.parameters.deployment["DANTE"]) window.Subdetectors[window.Subdetectors.length] = new DANTE();
          if(window.parameters.deployment["BAMBINO"]) window.Subdetectors[window.Subdetectors.length] = new BAMBINO();
          if(window.parameters.deployment["SCEPTAR"]) window.Subdetectors[window.Subdetectors.length] = new SCEPTAR();
          if(window.parameters.deployment["SPICE"]) window.Subdetectors[window.Subdetectors.length] = new SPICE();
          if(window.parameters.deployment["TIP"]) window.Subdetectors[window.Subdetectors.length] = new TIP();

          insertDOM('br', 'break', '', '', 'SubsystemLinks');
          //nav for different reported values:
          for(i=0; i<window.parameters.monitorValues.length; i++){
            var classDef
            //position 2 is default for now:
            if(i==2) classDef = 'navLinkDown';
            else classDef = 'navLink'; 
            insertDOM('button', 'subsystem'+window.parameters.monitorValues[i], classDef, '', 'SubsystemLinks', "javascript:swapSubsystemView('subsystem"+window.parameters.monitorValues[i]+"', 'SubsystemLinks', "+i+")", window.parameters.monitorValues[i], '', 'button')
          }
          window.subsystemScalars = window.parameters.monitorValues.length;

          //make the top level nav button default to the first subdetector in the list:
          document.getElementById('SubsystemsButton').setAttribute('onclick', "javascript:swapView('SubsystemLinks', '"+window.Subdetectors[0].canvasID+"', 'SubsystemSidebar', 'SubsystemsButton')")

          //make the nav button of the first subdetector in the list pressed by default:
          document.getElementById(window.Subdetectors[0].subviewLink).setAttribute('class', 'navLinkDown');
        } //end subsystem deployment

        //DAQ
        if(window.parameters.topDeployment['DAQ'])
          window.DAQ = new DAQ('DAQcanvas', 'DAQdetailCanvas', [], []);
        //Clock
        if(window.parameters.topDeployment['Clock'])
          window.Clock = new Clock();
        //Trigger
        if(window.parameters.topDeployment['Trigger'])
          window.Trigger = new Trigger();
        //end main elements////////////////////////////////////////////////////////////////////////////

        //style the sidebar backgrounds:
        document.getElementById('LeftSidebarBKG').width = parseInt(($('#leftSidebar').css('width')).slice(0,3));
        document.getElementById('LeftSidebarBKG').height = renderHeight*0.9; //parseInt($('#InputLayer').css('height').slice(0,3));
        tabBKG('LeftSidebarBKG', 'left');
        document.getElementById('LeftSidebarDetailBKG').width = parseInt(($('#leftSidebar').css('width')).slice(0,3));
        document.getElementById('LeftSidebarDetailBKG').height = renderHeight*0.9; //parseInt($('#InputLayer').css('height').slice(0,3));
        tabBKG('LeftSidebarDetailBKG', 'left');
        if(document.getElementById('InputLayer'))
          document.getElementById('SidebarBKG').width = parseInt(($('#InputLayer').css('width')).slice(0,3));
        else
          document.getElementById('SidebarBKG').width = document.getElementById('LeftSidebarBKG').width; 
        document.getElementById('SidebarBKG').height = renderHeight*0.9; //parseInt($('#InputLayer').css('height').slice(0,3));
        tabBKG('SidebarBKG', 'right');

        //position right sidebar nicely:
        var rightSidebarWhitespace = parseFloat(window.innerHeight*0.85) - parseFloat($('#InputLayer').height());
        //$('.Sidebar').css('top', Math.min(0, 0.3*rightSidebarWhitespace) );
        //$('#SidebarBKG').css('top', Math.min(0, 0.3*rightSidebarWhitespace) );

        //set up channel navigation dropdowns:
        if(window.parameters.topDeployment['HV']){
          configureDropdowns('ChannelList', 'CardList', moduleLabels, window.parameters.moduleSizes);
          document.getElementById('CardList').onblur = function(event){reconfigureChannelList(moduleLabels, window.parameters.moduleSizes, 'ChannelList')};
        }

        //global variables todo: try and cut down on these/////////////////////////////////////////////
        //which nav panel is on top?
        window.navOnDisplay = 'DashboardLinks';
        //which canvas is on top?
        window.onDisplay = 'DashboardCanvas';
        //which sidebar is on top?
        window.sidebarOnDisplay = 'DashboardSidebar';
        //which view state button is depressed?
        window.viewState = 'DashboardButton';
        //which was the last nav button pushed?
        window.lastTrip = 'Main1';
        //should the input sidebar be refreshed?
        window.refreshInput = 1;
        //which DAQ detail is on display in the DAQ view?
        window.DAQdetail = -1;
        //something to hold the settimeout loop so it can be stopped from anywhere:
        window.loop;
        //...and similar for animation loops:
        window.animateLoop;
        window.transAnimateLoop;
        //status flag for if the Commit button is blinking on loop:
        window.commitBlink = 0;
        //end globals//////////////////////////////////////////////////////////////////////////////////

        if(window.parameters.devMode == 0){
          //hack to put subsystems on top for TIP deploy
          if(window.parameters.topDeployment['Subsystems']) swapView('SubsystemLinks', window.Subdetectors[0].canvasID, 'SubsystemSidebar', 'SubsystemsButton')
          else if(!window.parameters.topDeployment['Trigger']) swapView('mainframeLinks', 'TestWaffle', 'InputLayer', 'HVmonitorButton');
          //hack to patch in HV assets:
          insertDOM('button', 'HVhackButton', 'navLink', '', 'statusLink', 'window.location="http://alphadon.triumf.ca:8082/CS/HV-Dashboard"', 'HV Status', '', 'submit');
        }

        startLoop(); 

        $('#setValues').on('change', function(event){highlight('submitParameters')})

      }

      window.freshLoad = 1;
      function startLoop(){
        loadJSONP(window.Gatekeeper, 0);
      }

    </script> 
  </body>
</html>
