<html> 
  <head>

    <link rel="icon" type="image/png" href="favicon.png" />

    <link href='http://fonts.googleapis.com/css?family=Orbitron' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Raleway' rel='stylesheet' type='text/css'>

    <script src="zepto.min.js" type="text/javascript"></script>
    <script src="utilities.js" type="text/javascript"></script>
    <script src="masterControl.js" type="text/javascript"></script>
    <script src="viewTransitions.js" type="text/javascript"></script>
    <script src="drawing.js" type="text/javascript"></script>
    <script src="DOMmanipulation.js" type="text/javascript"></script>

    <script src="Dashboard.js" type="text/javascript"></script>
    <script src="Waffle.js" type="text/javascript"></script>
    <script src="DAQ.js" type="text/javascript"></script>
    <script src="Clock.js" type="text/javascript"></script>
    <script src="Trigger.js" type="text/javascript"></script>

    <script src="masterCodex.js" type="text/javascript"></script>
    <script src="DataStructures.js" type="text/javascript"></script>
    <script src="AlarmService.js" type="text/javascript"></script>
    <script src="tooltip.js" type="text/javascript"></script>
    <script src="formHandler.js" type="text/javascript"></script>
    <script src="slider.js" type="text/javascript"></script>
    <script src="fillMeter.js" type="text/javascript"></script>
    <script src="branding.js" type="text/javascript"></script>
    <!--script src="navigation.js" type="text/javascript"></script-->

    <script src="BarGraph.js" type="text/javascript"></script>
    <script src="SHARC.js" type="text/javascript"></script>
    <script src="DESCANT.js" type="text/javascript"></script>
    <script src="HPGE.js" type="text/javascript"></script>
    <script src="PACES.js" type="text/javascript"></script>
    <script src="DANTE.js" type="text/javascript"></script>
    <script src="BAMBINO.js" type="text/javascript"></script>
    <script src="SCEPTAR.js" type="text/javascript"></script>
    <script src="SPICE.js" type="text/javascript"></script>
    <script src="TIP.js" type="text/javascript"></script>

    <!--link rel="stylesheet" type="text/css" href="cssreset.css"-->
    <link rel="stylesheet" type="text/css" href="GRIFFINcc.css" />

  </head> 


  <body style="font-family: 'Raleway', sans-serif; font-size:14px; background-color:#333333; color:#FFFFFF; margin-left:0px"> 

    <!--Branding///////////////////////////////////////////////////////////-->
    <canvas id="banner"></canvas>

    <!--Top Level Navigation////////////////////////////////////////////////////////////-->
    <div id="navBar" style='margin:none;'>
      <div id='statusLink' style='display:inline; position:relative; left:1%;'>
        <button class='navLink' type="submit">MIDAS Status</button>
        <!--All other objects will insert their nav buttons here-->
      </div>
      <p id="youAreHere" style='display: inline; color:rgba(255,255,255,0.3); font-size:24px; margin:0; position:absolute; right:0; width:;'></p>
    </div>

    <!--Waffleplate////////////////////////////////////////////////////////-->

    <div id="waffleplate">      

      <!--Left Sidebar: alarms, run control, etc-->
      <!--background layer at z=0; summary level at z=1; detail hidden at z<0, called forward to z=2 onclick-->
      <div id='leftSidebarDetail' class='leftSidebar' style='z-index:-1; opacity:0;'>
        <canvas id='LeftSidebarDetailBKG' style='position:absolute; z-index:-1; left:0%;'> </canvas>  
      </div>
      <canvas id='LeftSidebarBKG' style='position:absolute; z-index:0; left:0%;'> </canvas>
      <div id='leftSidebar' class='leftSidebar' style='z-index:1;'></div>

      <!--Right Sidebars///////////////////////////////////////////////////-->

      <canvas id='SidebarBKG' style='position:absolute; z-index:-1; right:0%'> </canvas>

    </div>
  <!--End Waffleplate////////////////////////////////////////////////////-->

  <script type="text/JavaScript">

      //--------------Experiment-specific Parameters Here--------------------------------------------------
      //---------------------------------------------------------------------------------------------------
 
      //HV Monitor//////////////////////////////////////////////////////////////////////////////////////////////////
      var ODBkeys = ['/Location/Of/Device/Varibles', '/Location/Of/Device/Settings', 'Demand Voltage Key', 'Measured Voltage Key', 'Measured Current Key', 'Voltage Ramp Up Key', 'Voltage Ramp Down Key', 'Temperature Key', 'ChState Key', 'ChStatus Key', 'Voltage Limit Key', 'Current Limit Key'];

      //cell labels; first entry decribes cell type
      var rowTitles = ['Ch.', '0', '1', '2', '3', '4', '5', '6', '7', '8', '9', '10', '11'];

      //alarm thresholds [voltage, current, temperature]:
      var alarmThresholds = [0.8, 0.999, 0.999, 0];

      //scale maxima [voltage, current, temperature]:
      var scaleMaxima = [1,1,1,1];

      //tooltip info prefixes & postfixes:
      var prefix = ['Demand Voltage: ', 'Reported Voltage: ', 'Reported Current: ', 'Voltage Ramp Up Speed: ', 'Voltage Ramp Down Speed', 'Temperature: ', 'Status: '];
      var postfix = ['V', 'V', 'A', 'V/s', 'V/s', 'C', ''];

      //demand voltage range:
      var minVoltage = 0;
      var maxVoltage = 1;

      //current meter range:
      var minCurrent = 0;
      var maxCurrent = 1;

      //temperature meter range:
      var minTemperature = 0;
      var maxTemperature = 1;

      //voltage ramp speed range:
      var minRampSpeed = 0;
      var maxRampSpeed = 1;

      //number of decimal places to keep on the sliders and status pane:
      var statusPrecision = 3;
      //number of decimal places to keep on the bar chart y-axis:
      var barChartPrecision = 1;
      //number of decimal places to keep on the alarms:
      var alarmPrecision = 3;

      //voltage unit:
      var voltUnit = 'V';
      //ramp speed unit:
      var rampUnit = 'V/s';
      //current unit:
      var currentUnit = 'uA';
      //temperature unit:
      var temperatureUnit = 'C';

      //url of MIDAS status page
      var statusURL = 'http://horus.triumf.ca:8081';

      //SHARC Monitor/////////////////////////////////////////////////////////////////////////
      //rows & columns of detectors:
      var SMrows = 2;
      var SMcolumns = 4;

      //odb keys
      var SM_ODBkeys = ['/Location/Of/Device/Varibles', '/Location/Of/Device/Settings', 'HV Key'];

      //number of channels per detector:
      var SMnChannels = 16;

      //arrays of scale minima and maxima:
      var SMminima = [0];
      var SMmaxima = [1];

      //DAQ//////////////////////////////////////////////////////////////////////////////////
      var DAQminima = [0,0,0,0,0,0,0,0,0];
      var DAQmaxima = [1,1,1,1,1,1,1,1,1];

      //---------------End Experiment-specific parameters--------------------------------------------------
      //---------------------------------------------------------------------------------------------------

      //different color scales for use in colorScale function: [initial R,G,B, final R,G,B]
      window.colorScales = [];
      window.colorScales[0] = [76,76,76,142,237,48];    //grey->green
      window.colorScales[1] = [255,255,0,255,51,00];    //sunburst
      window.colorScales[2] = [0,0,255,255,255,0]; //blue->yellow
      window.colorScales[3] = [100,100,100,255,255,255];  //grey->white
      window.colorScales[4] = [107,0,178,255,102,204];  //horrible fuchia
      //todo: black->purple->red->orange->yellow->white

      //state variables for what the subdetector view is showing: 0->HV, 1->Thresholds, 2->Rate
      window.subdetectorView = 1;  //Thresholds by default

      var i,j,k;

      //autodetect what size cards are plugged into what slot:
      var moduleSizes = detectCards();

      //rows & columns:
      var rows = 12;
      var columns = 0;
      for(i=0; i<moduleSizes.length; i++){
        columns += moduleSizes[i];
        if (moduleSizes[i] == 0) columns++;
      }

      moduleLabels = [];
      for(i=0; i<moduleSizes.length; i++){
        moduleLabels[i] = 'Slot '+i;
      }

      //Insert branding & navigation:
      Banner('banner', 'youAreHere', 'navBar', 'GRIFFIN Dashboard');

      //plug in links:
      statusLink = document.getElementById('statusLink');
      statusLink.setAttribute('action', statusURL);

      //set up wrapper div dimensions; minimum rendering width = 1440px, height 900px:
      var renderWidth = Math.max(1440, window.innerWidth);
      var renderHeight = Math.max(900*0.85,window.innerHeight*0.85)
      $('#waffleplate').width(renderWidth);
      $('#waffleplate').height(renderHeight);

      //Waffle onclick event will throw x and y positions up to these globals, so that
      //updateParameter() can use them to determine which channel to update.  TODO: fix
      //without globals.
      window.griffinDialogX;
      window.griffinDialogY;

      //declare objects:

      //master codex for finding data:
      window.codex = new masterCodex();

      //main elements///////////////////////////////////////////////////
      //dashboard
      var dashboard = new Dashboard('waffleplate');

      //Alarm Service
      var AlarmServices = new AlarmService('leftSidebar', 'leftSidebarDetail', alarmThresholds, scaleMaxima, alarmPrecision);

      //HV monitor
      var waffle = new Waffle(rows,columns, "waffleplate", rowTitles, "InputLayer", ODBkeys,'mainframeLinks', moduleSizes, barChartPrecision, prefix, postfix, AlarmServices);

      //Subsystem sidebar:
      insertDiv('SubsystemSidebar', 'Sidebar', 'waffleplate');
      //Subsystem menu; universal buttons declared outside of individual subsystems:
      //add top level nav button:
      insertButton('SubsystemsButton', 'navLink', "javascript:swapView('SubsystemLinks', 'SHARCCanvas', 'SubsystemSidebar', 'SubsystemsButton')", 'statusLink', 'Subsystem Monitors');
      //create nav panel for subsystem view:
      insertDiv('SubsystemLinks', 'navPanel', 'waffleplate');
      //headline for nav panel
      insertH1('SubsystemLinksBanner', 'navPanelHeader', 'SubsystemLinks', 'GRIFFIN Subsystem Monitors');
      insertLinebreak('SubsystemLinks');    
      //subdetectors
      var SHARCMonitor = new SHARC('waffleplate','horizontal', SMrows, SMcolumns, SMnChannels, 4, 4, 1, 16, SMminima, SMmaxima, [],[]);
      var HPGEMonitor = new HPGE('waffleplate', 1, [0,0,0], [1,1,1], [], [], 'GRIFFIN');
      var DESCANTMonitor = new DESCANT('waffleplate', [0,0,0], [1,1,1], [],[]);
      var PACESMonitor = new PACES('waffleplate', [0,0,0], [1,1,1], [], []);
      var DANTEMonitor = new DANTE('waffleplate', [0,0,0], [1,1,1]);
      var BAMBINOMonitor = new BAMBINO('waffleplate', 'S3', [0,0,0], [1,1,1]);
      var SCEPTARMonitor = new SCEPTAR('waffleplate', [0,0,0], [1,1,1], [1,0,1]);
      var SPICEMonitor = new SPICE('waffleplate', [0,0,0], [1,1,1]);
      var TIPMonitor = new TIP('waffleplate', [0,0,0], [1,1,1], [], []);
      insertLinebreak('SubsystemLinks');
      //nav for different reported values:
      //values to report:
      var monitorValues = ['HV', 'Thresholds', 'Rate'];
      for(i=0; i<monitorValues.length; i++){
        var classDef
        //position 1 is default for now:
        if(i==1) classDef = 'navLinkDown';
        else classDef = 'navLink'; 
        insertButton('subsystem'+monitorValues[i], classDef, "javascript:swapSubsystemView('subsystem"+monitorValues[i]+"', 'SubsystemLinks', "+i+")", 'SubsystemLinks', monitorValues[i]);

      }
      window.subsystemScalars = monitorValues.length;

      var DAQMonitor = new DAQ('waffleplate', 'DAQcanvas', 'DAQdetailCanvas', DAQminima, DAQmaxima, [], []);

      var ClockMonitor = new Clock('waffleplate');
      ClockMonitor.draw(ClockMonitor.nFrames);

      var TriggerMonitor = new Trigger('waffleplate');
      //end main elements////////////////////////////////////////////////////////////////////////////

      //style the sidebar backgrounds:
      document.getElementById('LeftSidebarBKG').width = parseInt(($('#leftSidebar').css('width')).slice(0,3));
      document.getElementById('LeftSidebarBKG').height = renderHeight*0.9; //parseInt($('#InputLayer').css('height').slice(0,3));
      tabBKG('LeftSidebarBKG', 'left');
      document.getElementById('LeftSidebarDetailBKG').width = parseInt(($('#leftSidebar').css('width')).slice(0,3));
      document.getElementById('LeftSidebarDetailBKG').height = renderHeight*0.9; //parseInt($('#InputLayer').css('height').slice(0,3));
      tabBKG('LeftSidebarDetailBKG', 'left');
      document.getElementById('SidebarBKG').width = parseInt(($('#InputLayer').css('width')).slice(0,3));
      document.getElementById('SidebarBKG').height = renderHeight*0.9; //parseInt($('#InputLayer').css('height').slice(0,3));
      tabBKG('SidebarBKG', 'right');

      //position right sidebar nicely:
      var rightSidebarWhitespace = parseFloat(window.innerHeight*0.85) - parseFloat($('#InputLayer').height());
      $('.Sidebar').css('top', Math.min(0, 0.3*rightSidebarWhitespace) );
      $('#SidebarBKG').css('top', Math.min(0, 0.3*rightSidebarWhitespace) );

      //set up channel navigation dropdowns:
      configureDropdowns('ChannelList', 'CardList', moduleLabels, moduleSizes);
      document.getElementById('CardList').onblur = function(event){reconfigureChannelList(moduleLabels, moduleSizes, 'ChannelList')};

      //global variables todo: try and cut down on these/////////////////////////////////////////////
      //which nav panel is on top?
      window.navOnDisplay = 'DashboardLinks';
      //which canvas is on top?
      window.onDisplay = 'DashboardCanvas';
      //which sidebar is on top?
      window.sidebarOnDisplay = 'DashboardSidebar';
      //which view state button is depressed?
      window.viewState = 'DashboardButton';
      //which was the last nav button pushed?
      window.lastTrip = 'Main1';
      //should the input sidebar be refreshed?
      window.refreshInput = 1;
      //which DAQ detail is on display in the DAQ view?
      window.DAQdetail = -1;
      //something to hold the settimeout loop so it can be stopped from anywhere:
      window.loop;
      //...and similar for animation loops:
      window.animateLoop;
      window.transAnimateLoop;
      //status flag for if the Commit button is blinking on loop:
      window.commitBlink = 0;
      //hack so getMIDASindex can access these from anywhere.  TODO: fix
      window.rows = rows;
      window.moduleSizes = moduleSizes;
      //hack so this is available to the alarms easily; will remove on alarm refactor
      window.precision = statusPrecision;
      //end globals//////////////////////////////////////////////////////////////////////////////////

      //wrap this in a function so it can be easily called to restart the loop somewhere else:
      function startLoop(callMyself){
        masterLoop(dashboard, AlarmServices, waffle, SHARCMonitor, HPGEMonitor, DESCANTMonitor, PACESMonitor, DANTEMonitor, BAMBINOMonitor, SCEPTARMonitor, SPICEMonitor, TIPMonitor, DAQMonitor, ClockMonitor, TriggerMonitor, callMyself);
      }
      startLoop(0); 

      $('#setValues').on('change', function(event){highlight('submitParameters')})
/*
      xmlhttp = new XMLHttpRequest();
      xmlhttp.open("GET","note.xml",false);
      xmlhttp.send();
      xmlDoc=xmlhttp.responseXML;
      alert(xmlDoc.getElementsByTagName("to")[0].childNodes[0].nodeValue);
*/

  </script> 
  
  </body>
 
</html>
